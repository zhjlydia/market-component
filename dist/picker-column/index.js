import { SpuiComponent } from '../common/component';
import { isObj, range } from '../common/utils';
const DEFAULT_DURATION = 200;
SpuiComponent({
  classes: ['active-class'],
  props: {
    valueKey: String,
    className: String,
    itemHeight: Number,
    visibleItemCount: Number,
    initialOptions: {
      type: Array,
      value: []
    },
    defaultIndex: {
      type: Number,
      value: 0
    }
  },
  data: {
    startY: 0,
    offset: 0,
    duration: 0,
    startOffset: 0,
    options: [],
    currentIndex: 0
  },

  created() {
    const {
      defaultIndex,
      initialOptions
    } = this.data;
    this.set({
      currentIndex: defaultIndex,
      options: initialOptions
    });
  },

  computed: {
    count() {
      return this.data.options.length;
    },

    baseOffset() {
      const {
        data
      } = this;
      return data.itemHeight * (data.visibleItemCount - 1) / 2;
    },

    wrapperStyle() {
      const {
        data
      } = this;
      return [`transition: ${data.duration}ms`, `transform: translate3d(0, ${data.offset + data.baseOffset}px, 0)`, `line-height: ${data.itemHeight}px`].join('; ');
    }

  },
  watch: {
    defaultIndex(value) {
      this.setIndex(value);
    }

  },
  methods: {
    onTouchStart(event) {
      this.set({
        startY: event.touches[0].clientY,
        startOffset: this.data.offset,
        duration: 0
      });
    },

    onTouchMove(event) {
      const {
        data
      } = this;
      const deltaY = event.touches[0].clientY - data.startY;
      this.set({
        offset: range(data.startOffset + deltaY, -(data.count * data.itemHeight), data.itemHeight)
      });
    },

    onTouchEnd() {
      const {
        data
      } = this;

      if (data.offset !== data.startOffset) {
        this.set({
          duration: DEFAULT_DURATION
        });
        const index = range(Math.round(-data.offset / data.itemHeight), 0, data.count - 1);
        this.setIndex(index, true);
      }
    },

    onClickItem(event) {
      const {
        index
      } = event.currentTarget.dataset;
      this.setIndex(index, true);
    },

    adjustIndex(index) {
      const {
        data
      } = this;
      index = range(index, 0, data.count);

      for (let i = index; i < data.count; i++) {
        if (!this.isDisabled(data.options[i])) return i;
      }

      for (let i = index - 1; i >= 0; i--) {
        if (!this.isDisabled(data.options[i])) return i;
      }
    },

    isDisabled(option) {
      return isObj(option) && option.disabled;
    },

    getOptionText(option) {
      const {
        data
      } = this;
      return isObj(option) && data.valueKey in option ? option[data.valueKey] : option;
    },

    setIndex(index, userAction) {
      const {
        data
      } = this;
      index = this.adjustIndex(index) || 0;
      this.set({
        offset: -index * data.itemHeight
      });

      if (index !== data.currentIndex) {
        this.set({
          currentIndex: index
        });
        userAction && this.$emit('change', index);
      }
    },

    setValue(value) {
      const {
        options
      } = this.data;

      for (let i = 0; i < options.length; i++) {
        if (this.getOptionText(options[i]) === value) {
          return this.setIndex(i);
        }
      }
    },

    getValue() {
      const {
        data
      } = this;
      return data.options[data.currentIndex];
    }

  }
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBpY2tlci1jb2x1bW4vaW5kZXgudHMiXSwibmFtZXMiOlsiU3B1aUNvbXBvbmVudCIsImlzT2JqIiwicmFuZ2UiLCJERUZBVUxUX0RVUkFUSU9OIiwiY2xhc3NlcyIsInByb3BzIiwidmFsdWVLZXkiLCJTdHJpbmciLCJjbGFzc05hbWUiLCJpdGVtSGVpZ2h0IiwiTnVtYmVyIiwidmlzaWJsZUl0ZW1Db3VudCIsImluaXRpYWxPcHRpb25zIiwidHlwZSIsIkFycmF5IiwidmFsdWUiLCJkZWZhdWx0SW5kZXgiLCJkYXRhIiwic3RhcnRZIiwib2Zmc2V0IiwiZHVyYXRpb24iLCJzdGFydE9mZnNldCIsIm9wdGlvbnMiLCJjdXJyZW50SW5kZXgiLCJjcmVhdGVkIiwic2V0IiwiY29tcHV0ZWQiLCJjb3VudCIsImxlbmd0aCIsImJhc2VPZmZzZXQiLCJ3cmFwcGVyU3R5bGUiLCJqb2luIiwid2F0Y2giLCJzZXRJbmRleCIsIm1ldGhvZHMiLCJvblRvdWNoU3RhcnQiLCJldmVudCIsInRvdWNoZXMiLCJjbGllbnRZIiwib25Ub3VjaE1vdmUiLCJkZWx0YVkiLCJvblRvdWNoRW5kIiwiaW5kZXgiLCJNYXRoIiwicm91bmQiLCJvbkNsaWNrSXRlbSIsImN1cnJlbnRUYXJnZXQiLCJkYXRhc2V0IiwiYWRqdXN0SW5kZXgiLCJpIiwiaXNEaXNhYmxlZCIsIm9wdGlvbiIsImRpc2FibGVkIiwiZ2V0T3B0aW9uVGV4dCIsInVzZXJBY3Rpb24iLCIkZW1pdCIsInNldFZhbHVlIiwiZ2V0VmFsdWUiXSwibWFwcGluZ3MiOiJBQUFBLFNBQVNBLGFBQVQsUUFBOEIscUJBQTlCO0FBQ0EsU0FBU0MsS0FBVCxFQUFnQkMsS0FBaEIsUUFBNkIsaUJBQTdCO0FBRUEsTUFBTUMsZ0JBQWdCLEdBQUcsR0FBekI7QUFFQUgsYUFBYSxDQUFDO0FBQ1pJLEVBQUFBLE9BQU8sRUFBRSxDQUFDLGNBQUQsQ0FERztBQUdaQyxFQUFBQSxLQUFLLEVBQUU7QUFDTEMsSUFBQUEsUUFBUSxFQUFF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LEtBQXJCLENBQWQ7QUFDRDtBQUNGLEtBN0VNOztBQStFUGMsSUFBQUEsUUFBUSxDQUFDekMsS0FBRCxFQUFjO0FBQ3BCLFlBQU07QUFBRU8sUUFBQUE7QUFBRixVQUFjLEtBQUtMLElBQXpCOztBQUNBLFdBQUssSUFBSWdDLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUczQixPQUFPLENBQUNNLE1BQTVCLEVBQW9DcUIsQ0FBQyxFQUFyQyxFQUF5QztBQUN2QyxZQUFJLEtBQUtJLGFBQUwsQ0FBbUIvQixPQUFPLENBQUMyQixDQUFELENBQTFCLE1BQW1DbEMsS0FBdkMsRUFBOEM7QUFDNUMsaUJBQU8sS0FBS2tCLFFBQUwsQ0FBY2dCLENBQWQsQ0FBUDtBQUNEO0FBQ0Y7QUFDRixLQXRGTTs7QUF3RlBRLElBQUFBLFFBQVEsR0FBQTtBQUNOLFlBQU07QUFBRXhDLFFBQUFBO0FBQUYsVUFBVyxJQUFqQjtBQUNBLGFBQU9BLElBQUksQ0FBQ0ssT0FBTCxDQUFhTCxJQUFJLENBQUNNLFlBQWxCLENBQVA7QUFDRDs7QUEzRk07QUE3REcsQ0FBRCxDQUFiIiwiZmlsZSI6InBpY2tlci1jb2x1bW4vaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTcHVpQ29tcG9uZW50IH0gZnJvbSAnLi4vY29tbW9uL2NvbXBvbmVudCc7XHJcbmltcG9ydCB7IGlzT2JqLCByYW5nZSB9IGZyb20gJy4uL2NvbW1vbi91dGlscyc7XHJcblxyXG5jb25zdCBERUZBVUxUX0RVUkFUSU9OID0gMjAwO1xyXG5cclxuU3B1aUNvbXBvbmVudCh7XHJcbiAgY2xhc3NlczogWydhY3RpdmUtY2xhc3MnXSxcclxuXHJcbiAgcHJvcHM6IHtcclxuICAgIHZhbHVlS2V5OiBTdHJpbmcsXHJcbiAgICBjbGFzc05hbWU6IFN0cmluZyxcclxuICAgIGl0ZW1IZWlnaHQ6IE51bWJlcixcclxuICAgIHZpc2libGVJdGVtQ291bnQ6IE51bWJlcixcclxuICAgIGluaXRpYWxPcHRpb25zOiB7XHJcbiAgICAgIHR5cGU6IEFycmF5LFxyXG4gICAgICB2YWx1ZTogW11cclxuICAgIH0sXHJcbiAgICBkZWZhdWx0SW5kZXg6IHtcclxuICAgICAgdHlwZTogTnVtYmVyLFxyXG4gICAgICB2YWx1ZTogMFxyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIGRhdGE6IHtcclxuICAgIHN0YXJ0WTogMCxcclxuICAgIG9mZnNldDogMCxcclxuICAgIGR1cmF0aW9uOiAwLFxyXG4gICAgc3RhcnRPZmZzZXQ6IDAsXHJcbiAgICBvcHRpb25zOiBbXSxcclxuICAgIGN1cnJlbnRJbmRleDogMFxyXG4gIH0sXHJcblxyXG4gIGNyZWF0ZWQoKSB7XHJcbiAgICBjb25zdCB7IGRlZmF1bHRJbmRleCwgaW5pdGlhbE9wdGlvbnMgfSA9IHRoaXMuZGF0YTtcclxuICAgIHRoaXMuc2V0KHtcclxuICAgICAgY3VycmVudEluZGV4OiBkZWZhdWx0SW5kZXgsXHJcbiAgICAgIG9wdGlvbnM6IGluaXRpYWxPcHRpb25zXHJcbiAgICB9KTtcclxuICB9LFxyXG5cclxuICBjb21wdXRlZDoge1xyXG4gICAgY291bnQoKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmRhdGEub3B0aW9ucy5sZW5ndGg7XHJcbiAgICB9LFxyXG5cclxuICAgIGJhc2VPZmZzZXQoKSB7XHJcbiAgICAgIGNvbnN0IHsgZGF0YSB9ID0gdGhpcztcclxuICAgICAgcmV0dXJuIChkYXRhLml0ZW1IZWlnaHQgKiAoZGF0YS52aXNpYmxlSXRlbUNvdW50IC0gMSkpIC8gMjtcclxuICAgIH0sXHJcblxyXG4gICAgd3JhcHBlclN0eWxlKCkge1xyXG4gICAgICBjb25zdCB7IGRhdGEgfSA9IHRoaXM7XHJcbiAgICAgIHJldHVybiBbXHJcbiAgICAgICAgYHRyYW5zaXRpb246ICR7ZGF0YS5kdXJhdGlvbn1tc2AsXHJcbiAgICAgICAgYHRyYW5zZm9ybTogdHJhbnNsYXRlM2QoMCwgJHtkYXRhLm9mZnNldCArIGRhdGEuYmFzZU9mZnNldH1weCwgMClgLFxyXG4gICAgICAgIGBsaW5lLWhlaWdodDogJHtkYXRhLml0ZW1IZWlnaHR9cHhgXHJcbiAgICAgIF0uam9pbignOyAnKTtcclxuICAgIH1cclxuICB9LFxyXG5cclxuICB3YXRjaDoge1xyXG4gICAgZGVmYXVsdEluZGV4KHZhbHVlOiBudW1iZXIpIHtcclxuICAgICAgdGhpcy5zZXRJbmRleCh2YWx1ZSk7XHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgbWV0aG9kczoge1xyXG4gICAgb25Ub3VjaFN0YXJ0KGV2ZW50OiBXZWFwcC5Ub3VjaEV2ZW50KSB7XHJcbiAgICAgIHRoaXMuc2V0KHtcclxuICAgICAgICBzdGFydFk6IGV2ZW50LnRvdWNoZXNbMF0uY2xpZW50WSxcclxuICAgICAgICBzdGFydE9mZnNldDogdGhpcy5kYXRhLm9mZnNldCxcclxuICAgICAgICBkdXJhdGlvbjogMFxyXG4gICAgICB9KTtcclxuICAgIH0sXHJcblxyXG4gICAgb25Ub3VjaE1vdmUoZXZlbnQ6IFdlYXBwLlRvdWNoRXZlbnQpIHtcclxuICAgICAgY29uc3QgeyBkYXRhIH0gPSB0aGlzO1xyXG4gICAgICBjb25zdCBkZWx0YVkgPSBldmVudC50b3VjaGVzWzBdLmNsaWVudFkgLSBkYXRhLnN0YXJ0WTtcclxuICAgICAgdGhpcy5zZXQoe1xyXG4gICAgICAgIG9mZnNldDogcmFuZ2UoXHJcbiAgICAgICAgICBkYXRhLnN0YXJ0T2Zmc2V0ICsgZGVsdGFZLFxyXG4gICAgICAgICAgLShkYXRhLmNvdW50ICogZGF0YS5pdGVtSGVpZ2h0KSxcclxuICAgICAgICAgIGRhdGEuaXRlbUhlaWdodFxyXG4gICAgICAgIClcclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIG9uVG91Y2hFbmQoKSB7XHJcbiAgICAgIGNvbnN0IHsgZGF0YSB9ID0gdGhpcztcclxuICAgICAgaWYgKGRhdGEub2Zmc2V0ICE9PSBkYXRhLnN0YXJ0T2Zmc2V0KSB7XHJcbiAgICAgICAgdGhpcy5zZXQoe1xyXG4gICAgICAgICAgZHVyYXRpb246IERFRkFVTFRfRFVSQVRJT05cclxuICAgICAgICB9KTtcclxuICAgICAgICBjb25zdCBpbmRleCA9IHJhbmdlKFxyXG4gICAgICAgICAgTWF0aC5yb3VuZCgtZGF0YS5vZmZzZXQgLyBkYXRhLml0ZW1IZWlnaHQpLFxyXG4gICAgICAgICAgMCxcclxuICAgICAgICAgIGRhdGEuY291bnQgLSAxXHJcbiAgICAgICAgKTtcclxuICAgICAgICB0aGlzLnNldEluZGV4KGluZGV4LCB0cnVlKTtcclxuICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBvbkNsaWNrSXRlbShldmVudDogV2VhcHAuRXZlbnQpIHtcclxuICAgICAgY29uc3QgeyBpbmRleCB9ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0O1xyXG4gICAgICB0aGlzLnNldEluZGV4KGluZGV4LCB0cnVlKTtcclxuICAgIH0sXHJcblxyXG4gICAgYWRqdXN0SW5kZXgoaW5kZXg6IG51bWJlcikge1xyXG4gICAgICBjb25zdCB7IGRhdGEgfSA9IHRoaXM7XHJcbiAgICAgIGluZGV4ID0gcmFuZ2UoaW5kZXgsIDAsIGRhdGEuY291bnQpO1xyXG4gICAgICBmb3IgKGxldCBpID0gaW5kZXg7IGkgPCBkYXRhLmNvdW50OyBpKyspIHtcclxuICAgICAgICBpZiAoIXRoaXMuaXNEaXNhYmxlZChkYXRhLm9wdGlvbnNbaV0pKSByZXR1cm4gaTtcclxuICAgICAgfVxyXG4gICAgICBmb3IgKGxldCBpID0gaW5kZXggLSAxOyBpID49IDA7IGktLSkge1xyXG4gICAgICAgIGlmICghdGhpcy5pc0Rpc2FibGVkKGRhdGEub3B0aW9uc1tpXSkpIHJldHVybiBpO1xyXG4gICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIGlzRGlzYWJsZWQob3B0aW9uOiBhbnkpIHtcclxuICAgICAgcmV0dXJuIGlzT2JqKG9wdGlvbikgJiYgb3B0aW9uLmRpc2FibGVkO1xyXG4gICAgfSxcclxuXHJcbiAgICBnZXRPcHRpb25UZXh0KG9wdGlvbjogYW55KSB7XHJcbiAgICAgIGNvbnN0IHsgZGF0YSB9ID0gdGhpcztcclxuICAgICAgcmV0dXJuIGlzT2JqKG9wdGlvbikgJiYgZGF0YS52YWx1ZUtleSBpbiBvcHRpb25cclxuICAgICAgICA/IG9wdGlvbltkYXRhLnZhbHVlS2V5XVxyXG4gICAgICAgIDogb3B0aW9uO1xyXG4gICAgfSxcclxuXHJcbiAgICBzZXRJbmRleChpbmRleDogbnVtYmVyLCB1c2VyQWN0aW9uOiBib29sZWFuKSB7XHJcbiAgICAgIGNvbnN0IHsgZGF0YSB9ID0gdGhpcztcclxuICAgICAgaW5kZXggPSB0aGlzLmFkanVzdEluZGV4KGluZGV4KSB8fCAwO1xyXG5cclxuICAgICAgdGhpcy5zZXQoe1xyXG4gICAgICAgIG9mZnNldDogLWluZGV4ICogZGF0YS5pdGVtSGVpZ2h0XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgaWYgKGluZGV4ICE9PSBkYXRhLmN1cnJlbnRJbmRleCkge1xyXG4gICAgICAgIHRoaXMuc2V0KHtcclxuICAgICAgICAgIGN1cnJlbnRJbmRleDogaW5kZXhcclxuICAgICAgICB9KTtcclxuICAgICAgICB1c2VyQWN0aW9uICYmIHRoaXMuJGVtaXQoJ2NoYW5nZScsIGluZGV4KTtcclxuICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBzZXRWYWx1ZSh2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICAgIGNvbnN0IHsgb3B0aW9ucyB9ID0gdGhpcy5kYXRhO1xyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9wdGlvbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBpZiAodGhpcy5nZXRPcHRpb25UZXh0KG9wdGlvbnNbaV0pID09PSB2YWx1ZSkge1xyXG4gICAgICAgICAgcmV0dXJuIHRoaXMuc2V0SW5kZXgoaSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIGdldFZhbHVlKCkge1xyXG4gICAgICBjb25zdCB7IGRhdGEgfSA9IHRoaXM7XHJcbiAgICAgIHJldHVybiBkYXRhLm9wdGlvbnNbZGF0YS5jdXJyZW50SW5kZXhdO1xyXG4gICAgfVxyXG4gIH1cclxufSk7XHJcbiJdfQ==
