import { SpuiComponent } from '../common/component';
import { touch } from '../mixins/touch';
SpuiComponent({
  mixins: [touch],
  relation: {
    name: 'tab',
    type: 'descendant',

    linked(child) {
      this.child.push(child);
      this.updateTabs(this.data.tabs.concat(child.data));
    },

    unlinked(child) {
      const index = this.child.indexOf(child);
      const {
        tabs
      } = this.data;
      tabs.splice(index, 1);
      this.child.splice(index, 1);
      this.updateTabs(tabs);
    }

  },
  props: {
    color: String,
    lineWidth: {
      type: Number,
      value: -1
    },
    active: {
      type: Number,
      value: 0
    },
    type: {
      type: String,
      value: 'line'
    },
    border: {
      type: Boolean,
      value: true
    },
    duration: {
      type: Number,
      value: 0.3
    },
    zIndex: {
      type: Number,
      value: 1
    },
    swipeThreshold: {
      type: Number,
      value: 4
    },
    animated: Boolean,
    sticky: Boolean,
    offsetTop: {
      type: Number,
      value: 0
    },
    swipeable: Boolean,
    scrollTop: {
      type: Number,
      value: 0
    }
  },
  data: {
    tabs: [],
    lineStyle: '',
    scrollLeft: 0,
    scrollable: false,
    trackStyle: '',
    wrapStyle: '',
    position: ''
  },
  watch: {
    swipeThreshold() {
      this.set({
        scrollable: this.child.length > this.data.swipeThreshold
      });
    },

    color: 'setLine',
    lineWidth: 'setLine',
    active: 'setActiveTab',
    animated: 'setTrack',
    scrollTop: 'onScroll',
    offsetTop: 'setWrapStyle'
  },

  beforeCreate() {
    this.child = [];
  },

  mounted() {
    this.setLine();
    this.setTrack();
    this.scrollIntoView();
  },

  methods: {
    updateTabs(tabs) {
      tabs = tabs || this.data.tabs;
      this.set({
        tabs,
        scrollable: tabs.length > this.data.swipeThreshold
      });
      this.setActiveTab();
    },

    trigger(eventName, index) {
      this.$emit(eventName, {
        index,
        title: this.data.tabs[index].title
      });
    },

    onTap(event) {
      const {
        index
      } = event.currentTarget.dataset;

      if (this.data.tabs[index].disabled) {
        this.trigger('disabled', index);
      } else {
        this.trigger('click', index);
        this.setActive(index);
      }
    },

    setActive(active) {
      if (active !== this.data.active) {
        this.trigger('change', active);
        this.set({
          active
        });
        this.setActiveTab();
      }
    },

    setLine() {
      if (this.data.type !== 'line') {
        return;
      }

      const {
        color,
        active,
        duration,
        lineWidth
      } = this.data;
      this.getRect('.spui-tab', true).then(rects => {
        const rect = rects[active];
        const width = lineWidth !== -1 ? lineWidth : rect.width / 2;
        let left = rects.slice(0, active).reduce((prev, curr) => prev + curr.width, 0);
        left += (rect.width - width) / 2;
        this.set({
          lineStyle: `
            width: ${width}px;
            background-color: ${color};
            -webkit-transform: translateX(${left}px);
            -webkit-transition-duration: ${duration}s;
            transform: translateX(${left}px);
            transition-duration: ${duration}s;
          `
        });
      });
    },

    setTrack() {
      const {
        animated,
        active,
        duration
      } = this.data;
      if (!animated) return '';
      this.getRect('.spui-tabs__content').then(rect => {
        const {
          width
        } = rect;
        this.set({
          trackStyle: `
            width: ${width * this.child.length}px;
            left: ${-1 * active * width}px;
            transition: left ${duration}s;
            display: flex;
          `
        });
        this.setTabsProps({
          width,
          animated
        });
      });
    },

    setTabsProps(props) {
      this.child.forEach(item => {
        item.set(props);
      });
    },

    setActiveTab() {
      this.child.forEach((item, index) => {
        const data = {
          active: index === this.data.active
        };

        if (data.active) {
          data.inited = true;
        }

        if (data.active !== item.data.active) {
          item.set(data);
        }
      });
      this.set({}, () => {
        this.setLine();
        this.setTrack();
        this.scrollIntoView();
      });
    },

    // scroll active tab into view
    scrollIntoView() {
      if (!this.data.scrollable) {
        return;
      }

      this.getRect('.spui-tab', true).then(tabRects => {
        const tabRect = tabRects[this.data.active];
        const offsetLeft = tabRects.slice(0, this.data.active).reduce((prev, curr) => prev + curr.width, 0);
        const tabWidth = tabRect.width;
        this.getRect('.spui-tabs__nav').then(navRect => {
          const navWidth = navRect.width;
          this.set({
            scrollLeft: offsetLeft - (navWidth - tabWidth) / 2
          });
        });
      });
    },

    onTouchStart(event) {
      if (!this.data.swipeable) return;
      this.touchStart(event);
    },

    onTouchMove(event) {
      if (!this.data.swipeable) return;
      this.touchMove(event);
    },

    // watch swipe touch end
    onTouchEnd() {
      if (!this.data.swipeable) return;
      const {
        active,
        tabs
      } = this.data;
      const {
        direction,
        deltaX,
        offsetX
      } = this;
      const minSwipeDistance = 50;

      if (direction === 'horizontal' && offsetX >= minSwipeDistance) {
        if (deltaX > 0 && active !== 0) {
          this.setActive(active - 1);
        } else if (deltaX < 0 && active !== tabs.length - 1) {
          this.setActive(active + 1);
        }
      }
    },

    setWrapStyle() {
      const {
        offsetTop,
        position
      } = this.data;
      let wrapStyle;

      switch (position) {
        case 'top':
          wrapStyle = `
            top: ${offsetTop}px;
            position: fixed;
          `;
          break;

        case 'bottom':
          wrapStyle = `
            top: auto;
            bottom: 0;
          `;
          break;

        default:
          wrapStyle = '';
      } // cut down `set`


      if (wrapStyle === this.data.wrapStyle) return;
      this.set({
        wrapStyle
      });
    },

    // adjust tab position
    onScroll(scrollTop) {
      if (!this.data.sticky) return;
      const {
        offsetTop
      } = this.data;
      this.getRect('.spui-tabs').then(rect => {
        const {
          top,
          height
        } = rect;
        this.getRect('.spui-tabs__wrap').then(rect => {
          const {
            height: wrapHeight
          } = rect;
          let position = '';

          if (offsetTop > top + height - wrapHeight) {
            position = 'bottom';
          } else if (offsetTop > top) {
            position = 'top';
          }

          this.$emit('scroll', {
            scrollTop: scrollTop + offsetTop,
            isFixed: position === 'top'
          });

          if (position !== this.data.position) {
            this.set({
              position
            }, () => {
              this.setWrapStyle();
            });
          }
        });
      });
    }

  }
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRhYnMvaW5kZXgudHMiXSwibmFtZXMiOlsiU3B1aUNvbXBvbmVudCIsInRvdWNoIiwibWl4aW5zIiwicmVsYXRpb24iLCJuYW1lIiwidHlwZSIsImxpbmtlZCIsImNoaWxkIiwicHVzaCIsInVwZGF0ZVRhYnMiLCJkYXRhIiwidGFicyIsImNvbmNhdCIsInVubGlua2VkIiwiaW5kZXgiLCJpbmRleE9mIiwic3BsaWNlIiwicHJvcHMiLCJjb2xvciIsIlN0cmluZyIsImxpbmVXaWR0aCIsIk51bWJlciIsInZhbHVlIiwiYWN0aXZlIiwiYm9yZGVyIiwiQm9vbGVhbiIsImR1cmF0aW9uIiwiekluZGV4Iiwic3dpcGVUaHJlc2hvbGQiLCJhbmltYXRlZCIsInN0aWNreSIsIm9mZnNldFRvcCIsInN3aXBlYWJsZSIsInNjcm9sbFRvcCIsImxpbmVTdHlsZSIsInNjcm9sbExlZnQiLCJzY3JvbGxhYmxlIiwidHJhY2tTdHlsZSIsIndyYXBTdHlsZSIsInBvc2l0aW9uIiwid2F0Y2giLCJzZXQiLCJsZW5ndGgiLCJiZWZvcmVDcmVhdGUiLCJtb3VudGVkIiwic2V0TGluZSIsInNldFRyYWNrIiwic2Nyb2xsSW50b1ZpZXciLCJtZXRob2RzIiwic2V0QWN0aXZlVGFiIiwidHJpZ2dlciIsImV2ZW50TmFtZSIsIiRlbWl0IiwidGl0bGUiLCJvblRhcCIsImV2ZW50IiwiY3VycmVudFRhcmdldCIsImRhdGFzZXQiLCJkaXNhYmxlZCIsInNldEFjdGl2ZSIsImdldFJlY3QiLCJ0aGVuIiwicmVjdHMiLCJyZWN0Iiwid2lkdGgiLCJsZWZ0Iiwic2xpY2UiLCJyZWR1Y2UiLCJwcmV2IiwiY3VyciIsInNldFRhYnNQcm9wcyIsImZvckVhY2giLCJpdGVtIiwiaW5pdGVkIiwidGFiUmVjdHMiLCJ0YWJSZWN0Iiwib2Zmc2V0TGVmdCIsInRhYldpZHRoIiwibmF2UmVjdCIsIm5hdldpZHRoIiwib25Ub3VjaFN0YXJ0IiwidG91Y2hTdGFydCIsIm9uVG91Y2hNb3ZlIiwidG91Y2hNb3ZlIiwib25Ub3VjaEVuZCIsImRpcmVjdGlvbiIsImRlbHRhWCIsIm9mZnNldFgiLCJtaW5Td2lwZURpc3RhbmNlIiwic2V0V3JhcFN0eWxlIiwib25TY3JvbGwiLCJ0b3AiLCJoZWlnaHQiLCJ3cmFwSGVpZ2h0IiwiaXNGaXhlZCJdLCJtYXBwaW5ncyI6IkFBQUEsU0FBU0EsYUFBVCxRQUE4QixxQkFBOUI7QUFDQSxTQUFTQyxLQUFULFFBQXNCLGlCQUF0QjtBQVNBRCxhQUFhLENBQUM7QUFDWkUsRUFBQUEsTUFBTSxFQUFFLENBQUNELEtBQUQsQ0FESTtBQUdaRSxFQUFBQSxRQUFRLEVBQUU7QUFDUkMsSUFBQUEsSUFBSSxFQUFFLEtBREU7QUFFUkMsSUFBQUEsSUFBSSxFQUFFLFlBRkU7O0FBR1JDLElBQUFBLE1BQU0sQ0FBQ0MsS0FBRCxFQUF1QjtBQUMzQixXQUFLQSxLQUFMLENBQVdDLElBQVgsQ0FBZ0JELEtBQWhCO0FBQ0EsV0FBS0UsVUFBTCxDQUFnQixLQUFLQyxJQUFMLENBQVVDLElBQVYsQ0FBZUMsTUFBZixDQUFzQkwsS0FBSyxDQUFDRyxJQUE1QixDQUFoQjtBQUNELEtBTk87O0FBT1JHLElBQUFBLFFBQVEsQ0FBQ04sS0FBRCxFQUF1QjtBQUM3QixZQUFNTyxLQUFLLEdBQUcsS0FBS1AsS0FBTCxDQUFXUSxPQUFYLENBQW1CUixLQUFuQixDQUFkO0FBQ0EsWUFBTTtBQUFFSSxRQUFBQTtBQUFGLFVBQVcsS0FBS0QsSUFBdEI7QUFDQUMsTUFBQUEsSUFBSSxDQUFDSyxNQUFMLENBQVlGLEtBQVosRUFBbUIsQ0FBbkI7QUFDQSxXQUFLUCxLQUFMLENBQVdTLE1BQVgsQ0FBa0JGLEtBQWxCLEVBQXlCLENBQXpCO0FBQ0EsV0FBS0wsVUFBTCxDQUFnQkUsSUFBaEI7QUFDRDs7QUFiTyxHQUhFO0FBbUJaTSxFQUFBQSxLQUFLLEVBQUU7QUFDTEMsSUFBQUEsS0FBSyxFQUFFQyxNQURGO0FBRUxDLElBQUFBLFNBQVMsRUFBRTtBQUNUZixNQUFBQSxJQUFJLEVBQUVnQixNQURHO0FB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LFFBQUFBO0FBQUYsVUFBZ0IsS0FBS3JCLElBQTNCO0FBRUEsV0FBS2tELE9BQUwsQ0FBYSxZQUFiLEVBQTJCQyxJQUEzQixDQUFnQ0UsSUFBSSxJQUFHO0FBQ3JDLGNBQU07QUFBRTRCLFVBQUFBLEdBQUY7QUFBT0MsVUFBQUE7QUFBUCxZQUFrQjdCLElBQXhCO0FBRUEsYUFBS0gsT0FBTCxDQUFhLGtCQUFiLEVBQWlDQyxJQUFqQyxDQUFzQ0UsSUFBSSxJQUFHO0FBQzNDLGdCQUFNO0FBQUU2QixZQUFBQSxNQUFNLEVBQUVDO0FBQVYsY0FBeUI5QixJQUEvQjtBQUNBLGNBQUl4QixRQUFRLEdBQUcsRUFBZjs7QUFFQSxjQUFJUixTQUFTLEdBQUc0RCxHQUFHLEdBQUdDLE1BQU4sR0FBZUMsVUFBL0IsRUFBMkM7QUFDekN0RCxZQUFBQSxRQUFRLEdBQUcsUUFBWDtBQUNELFdBRkQsTUFFTyxJQUFJUixTQUFTLEdBQUc0RCxHQUFoQixFQUFxQjtBQUMxQnBELFlBQUFBLFFBQVEsR0FBRyxLQUFYO0FBQ0Q7O0FBRUQsZUFBS2EsS0FBTCxDQUFXLFFBQVgsRUFBcUI7QUFDbkJuQixZQUFBQSxTQUFTLEVBQUVBLFNBQVMsR0FBR0YsU0FESjtBQUVuQitELFlBQUFBLE9BQU8sRUFBRXZELFFBQVEsS0FBSztBQUZILFdBQXJCOztBQUtBLGNBQUlBLFFBQVEsS0FBSyxLQUFLN0IsSUFBTCxDQUFVNkIsUUFBM0IsRUFBcUM7QUFDbkMsaUJBQUtFLEdBQUwsQ0FBUztBQUNQRixjQUFBQTtBQURPLGFBQVQsRUFFRyxNQUFLO0FBQ04sbUJBQUtrRCxZQUFMO0FBQ0QsYUFKRDtBQUtEO0FBQ0YsU0F0QkQ7QUF1QkQsT0ExQkQ7QUEyQkQ7O0FBL09NO0FBaEdHLENBQUQsQ0FBYiIsImZpbGUiOiJ0YWJzL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3B1aUNvbXBvbmVudCB9IGZyb20gJy4uL2NvbW1vbi9jb21wb25lbnQnO1xyXG5pbXBvcnQgeyB0b3VjaCB9IGZyb20gJy4uL21peGlucy90b3VjaCc7XHJcblxyXG50eXBlIFRhYkl0ZW1EYXRhID0ge1xyXG4gIGFjdGl2ZTogYm9vbGVhbjtcclxuICBpbml0ZWQ/OiBib29sZWFuO1xyXG4gIGFuaW1hdGVkPzogYm9vbGVhbjtcclxuICB3aWR0aD86IE51bWJlcjtcclxufTtcclxuXHJcblNwdWlDb21wb25lbnQoe1xyXG4gIG1peGluczogW3RvdWNoXSxcclxuXHJcbiAgcmVsYXRpb246IHtcclxuICAgIG5hbWU6ICd0YWInLFxyXG4gICAgdHlwZTogJ2Rlc2NlbmRhbnQnLFxyXG4gICAgbGlua2VkKGNoaWxkOiBXZWFwcC5Db21wb25lbnQpIHtcclxuICAgICAgdGhpcy5jaGlsZC5wdXNoKGNoaWxkKTtcclxuICAgICAgdGhpcy51cGRhdGVUYWJzKHRoaXMuZGF0YS50YWJzLmNvbmNhdChjaGlsZC5kYXRhKSk7XHJcbiAgICB9LFxyXG4gICAgdW5saW5rZWQoY2hpbGQ6IFdlYXBwLkNvbXBvbmVudCkge1xyXG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuY2hpbGQuaW5kZXhPZihjaGlsZCk7XHJcbiAgICAgIGNvbnN0IHsgdGFicyB9ID0gdGhpcy5kYXRhO1xyXG4gICAgICB0YWJzLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgIHRoaXMuY2hpbGQuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgdGhpcy51cGRhdGVUYWJzKHRhYnMpO1xyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIHByb3BzOiB7XHJcbiAgICBjb2xvcjogU3RyaW5nLFxyXG4gICAgbGluZVdpZHRoOiB7XHJcbiAgICAgIHR5cGU6IE51bWJlcixcclxuICAgICAgdmFsdWU6IC0xXHJcbiAgICB9LFxyXG4gICAgYWN0aXZlOiB7XHJcbiAgICAgIHR5cGU6IE51bWJlcixcclxuICAgICAgdmFsdWU6IDBcclxuICAgIH0sXHJcbiAgICB0eXBlOiB7XHJcbiAgICAgIHR5cGU6IFN0cmluZyxcclxuICAgICAgdmFsdWU6ICdsaW5lJ1xyXG4gICAgfSxcclxuICAgIGJvcmRlcjoge1xyXG4gICAgICB0eXBlOiBCb29sZWFuLFxyXG4gICAgICB2YWx1ZTogdHJ1ZVxyXG4gICAgfSxcclxuICAgIGR1cmF0aW9uOiB7XHJcbiAgICAgIHR5cGU6IE51bWJlcixcclxuICAgICAgdmFsdWU6IDAuM1xyXG4gICAgfSxcclxuICAgIHpJbmRleDoge1xyXG4gICAgICB0eXBlOiBOdW1iZXIsXHJcbiAgICAgIHZhbHVlOiAxXHJcbiAgICB9LFxyXG4gICAgc3dpcGVUaHJlc2hvbGQ6IHtcclxuICAgICAgdHlwZTogTnVtYmVyLFxyXG4gICAgICB2YWx1ZTogNFxyXG4gICAgfSxcclxuICAgIGFuaW1hdGVkOiBCb29sZWFuLFxyXG4gICAgc3RpY2t5OiBCb29sZWFuLFxyXG4gICAgb2Zmc2V0VG9wOiB7XHJcbiAgICAgIHR5cGU6IE51bWJlcixcclxuICAgICAgdmFsdWU6IDBcclxuICAgIH0sXHJcbiAgICBzd2lwZWFibGU6IEJvb2xlYW4sXHJcbiAgICBzY3JvbGxUb3A6IHtcclxuICAgICAgdHlwZTogTnVtYmVyLFxyXG4gICAgICB2YWx1ZTogMFxyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIGRhdGE6IHtcclxuICAgIHRhYnM6IFtdLFxyXG4gICAgbGluZVN0eWxlOiAnJyxcclxuICAgIHNjcm9sbExlZnQ6IDAsXHJcbiAgICBzY3JvbGxhYmxlOiBmYWxzZSxcclxuICAgIHRyYWNrU3R5bGU6ICcnLFxyXG4gICAgd3JhcFN0eWxlOiAnJyxcclxuICAgIHBvc2l0aW9uOiAnJ1xyXG4gIH0sXHJcblxyXG4gIHdhdGNoOiB7XHJcbiAgICBzd2lwZVRocmVzaG9sZCgpIHtcclxuICAgICAgdGhpcy5zZXQoe1xyXG4gICAgICAgIHNjcm9sbGFibGU6IHRoaXMuY2hpbGQubGVuZ3RoID4gdGhpcy5kYXRhLnN3aXBlVGhyZXNob2xkXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuICAgIGNvbG9yOiAnc2V0TGluZScsXHJcbiAgICBsaW5lV2lkdGg6ICdzZXRMaW5lJyxcclxuICAgIGFjdGl2ZTogJ3NldEFjdGl2ZVRhYicsXHJcbiAgICBhbmltYXRlZDogJ3NldFRyYWNrJyxcclxuICAgIHNjcm9sbFRvcDogJ29uU2Nyb2xsJyxcclxuICAgIG9mZnNldFRvcDogJ3NldFdyYXBTdHlsZSdcclxuICB9LFxyXG5cclxuICBiZWZvcmVDcmVhdGUoKSB7XHJcbiAgICB0aGlzLmNoaWxkID0gW107XHJcbiAgfSxcclxuXHJcbiAgbW91bnRlZCgpIHtcclxuICAgIHRoaXMuc2V0TGluZSgpO1xyXG4gICAgdGhpcy5zZXRUcmFjaygpO1xyXG4gICAgdGhpcy5zY3JvbGxJbnRvVmlldygpO1xyXG4gIH0sXHJcblxyXG4gIG1ldGhvZHM6IHtcclxuICAgIHVwZGF0ZVRhYnModGFicykge1xyXG4gICAgICB0YWJzID0gdGFicyB8fCB0aGlzLmRhdGEudGFicztcclxuICAgICAgdGhpcy5zZXQoe1xyXG4gICAgICAgIHRhYnMsXHJcbiAgICAgICAgc2Nyb2xsYWJsZTogdGFicy5sZW5ndGggPiB0aGlzLmRhdGEuc3dpcGVUaHJlc2hvbGRcclxuICAgICAgfSk7XHJcbiAgICAgIHRoaXMuc2V0QWN0aXZlVGFiKCk7XHJcbiAgICB9LFxyXG5cclxuICAgIHRyaWdnZXIoZXZlbnROYW1lOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpIHtcclxuICAgICAgdGhpcy4kZW1pdChldmVudE5hbWUsIHtcclxuICAgICAgICBpbmRleCxcclxuICAgICAgICB0aXRsZTogdGhpcy5kYXRhLnRhYnNbaW5kZXhdLnRpdGxlXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBvblRhcChldmVudDogV2VhcHAuRXZlbnQpIHtcclxuICAgICAgY29uc3QgeyBpbmRleCB9ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0O1xyXG4gICAgICBpZiAodGhpcy5kYXRhLnRhYnNbaW5kZXhdLmRpc2FibGVkKSB7XHJcbiAgICAgICAgdGhpcy50cmlnZ2VyKCdkaXNhYmxlZCcsIGluZGV4KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLnRyaWdnZXIoJ2NsaWNrJywgaW5kZXgpO1xyXG4gICAgICAgIHRoaXMuc2V0QWN0aXZlKGluZGV4KTtcclxuICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBzZXRBY3RpdmUoYWN0aXZlOiBudW1iZXIpIHtcclxuICAgICAgaWYgKGFjdGl2ZSAhPT0gdGhpcy5kYXRhLmFjdGl2ZSkge1xyXG4gICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlJywgYWN0aXZlKTtcclxuICAgICAgICB0aGlzLnNldCh7IGFjdGl2ZSB9KTtcclxuICAgICAgICB0aGlzLnNldEFjdGl2ZVRhYigpO1xyXG4gICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIHNldExpbmUoKSB7XHJcbiAgICAgIGlmICh0aGlzLmRhdGEudHlwZSAhPT0gJ2xpbmUnKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCB7XHJcbiAgICAgICAgY29sb3IsXHJcbiAgICAgICAgYWN0aXZlLFxyXG4gICAgICAgIGR1cmF0aW9uLFxyXG4gICAgICAgIGxpbmVXaWR0aFxyXG4gICAgICB9ID0gdGhpcy5kYXRhO1xyXG5cclxuICAgICAgdGhpcy5nZXRSZWN0KCcuc3B1aS10YWInLCB0cnVlKS50aGVuKHJlY3RzID0+IHtcclxuICAgICAgICBjb25zdCByZWN0ID0gcmVjdHNbYWN0aXZlXTtcclxuICAgICAgICBjb25zdCB3aWR0aCA9IChsaW5lV2lkdGggIT09IC0xKSA/IGxpbmVXaWR0aCA6IHJlY3Qud2lkdGggLyAyO1xyXG5cclxuICAgICAgICBsZXQgbGVmdCA9IHJlY3RzXHJcbiAgICAgICAgICAuc2xpY2UoMCwgYWN0aXZlKVxyXG4gICAgICAgICAgLnJlZHVjZSgocHJldiwgY3VycikgPT4gcHJldiArIGN1cnIud2lkdGgsIDApO1xyXG5cclxuICAgICAgICBsZWZ0ICs9IChyZWN0LndpZHRoIC0gd2lkdGgpIC8gMjtcclxuXHJcbiAgICAgICAgdGhpcy5zZXQoe1xyXG4gICAgICAgICAgbGluZVN0eWxlOiBgXHJcbiAgICAgICAgICAgIHdpZHRoOiAke3dpZHRofXB4O1xyXG4gICAgICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAke2NvbG9yfTtcclxuICAgICAgICAgICAgLXdlYmtpdC10cmFuc2Zvcm06IHRyYW5zbGF0ZVgoJHtsZWZ0fXB4KTtcclxuICAgICAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uLWR1cmF0aW9uOiAke2R1cmF0aW9ufXM7XHJcbiAgICAgICAgICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlWCgke2xlZnR9cHgpO1xyXG4gICAgICAgICAgICB0cmFuc2l0aW9uLWR1cmF0aW9uOiAke2R1cmF0aW9ufXM7XHJcbiAgICAgICAgICBgXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBzZXRUcmFjaygpIHtcclxuICAgICAgY29uc3Qge1xyXG4gICAgICAgIGFuaW1hdGVkLFxyXG4gICAgICAgIGFjdGl2ZSxcclxuICAgICAgICBkdXJhdGlvblxyXG4gICAgICB9ID0gdGhpcy5kYXRhO1xyXG5cclxuICAgICAgaWYgKCFhbmltYXRlZCkgcmV0dXJuICcnO1xyXG5cclxuICAgICAgdGhpcy5nZXRSZWN0KCcuc3B1aS10YWJzX19jb250ZW50JykudGhlbihyZWN0ID0+IHtcclxuICAgICAgICBjb25zdCB7IHdpZHRoIH0gPSByZWN0O1xyXG5cclxuICAgICAgICB0aGlzLnNldCh7XHJcbiAgICAgICAgICB0cmFja1N0eWxlOiBgXHJcbiAgICAgICAgICAgIHdpZHRoOiAke3dpZHRoICogdGhpcy5jaGlsZC5sZW5ndGh9cHg7XHJcbiAgICAgICAgICAgIGxlZnQ6ICR7LTEgKiBhY3RpdmUgKiB3aWR0aH1weDtcclxuICAgICAgICAgICAgdHJhbnNpdGlvbjogbGVmdCAke2R1cmF0aW9ufXM7XHJcbiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7XHJcbiAgICAgICAgICBgXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5zZXRUYWJzUHJvcHMoe1xyXG4gICAgICAgICAgd2lkdGgsXHJcbiAgICAgICAgICBhbmltYXRlZFxyXG4gICAgICAgIH0pXHJcbiAgICAgIH0pXHJcbiAgICB9LFxyXG5cclxuICAgIHNldFRhYnNQcm9wcyhwcm9wcykge1xyXG4gICAgICB0aGlzLmNoaWxkLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgaXRlbS5zZXQocHJvcHMpO1xyXG4gICAgICB9KTtcclxuICAgIH0sXHJcblxyXG4gICAgc2V0QWN0aXZlVGFiKCkge1xyXG4gICAgICB0aGlzLmNoaWxkLmZvckVhY2goKGl0ZW0sIGluZGV4KSA9PiB7XHJcbiAgICAgICAgY29uc3QgZGF0YTogVGFiSXRlbURhdGEgPSB7XHJcbiAgICAgICAgICBhY3RpdmU6IGluZGV4ID09PSB0aGlzLmRhdGEuYWN0aXZlXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaWYgKGRhdGEuYWN0aXZlKSB7XHJcbiAgICAgICAgICBkYXRhLmluaXRlZCA9IHRydWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoZGF0YS5hY3RpdmUgIT09IGl0ZW0uZGF0YS5hY3RpdmUpIHtcclxuICAgICAgICAgIGl0ZW0uc2V0KGRhdGEpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0aGlzLnNldCh7fSwgKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuc2V0TGluZSgpO1xyXG4gICAgICAgIHRoaXMuc2V0VHJhY2soKTtcclxuICAgICAgICB0aGlzLnNjcm9sbEludG9WaWV3KCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICAvLyBzY3JvbGwgYWN0aXZlIHRhYiBpbnRvIHZpZXdcclxuICAgIHNjcm9sbEludG9WaWV3KCkge1xyXG4gICAgICBpZiAoIXRoaXMuZGF0YS5zY3JvbGxhYmxlKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmdldFJlY3QoJy5zcHVpLXRhYicsIHRydWUpLnRoZW4odGFiUmVjdHMgPT4ge1xyXG4gICAgICAgIGNvbnN0IHRhYlJlY3QgPSB0YWJSZWN0c1t0aGlzLmRhdGEuYWN0aXZlXTtcclxuICAgICAgICBjb25zdCBvZmZzZXRMZWZ0ID0gdGFiUmVjdHNcclxuICAgICAgICAgIC5zbGljZSgwLCB0aGlzLmRhdGEuYWN0aXZlKVxyXG4gICAgICAgICAgLnJlZHVjZSgocHJldiwgY3VycikgPT4gcHJldiArIGN1cnIud2lkdGgsIDApO1xyXG4gICAgICAgIGNvbnN0IHRhYldpZHRoID0gdGFiUmVjdC53aWR0aDtcclxuXHJcbiAgICAgICAgdGhpcy5nZXRSZWN0KCcuc3B1aS10YWJzX19uYXYnKS50aGVuKG5hdlJlY3QgPT4ge1xyXG4gICAgICAgICAgY29uc3QgbmF2V2lkdGggPSBuYXZSZWN0LndpZHRoO1xyXG4gICAgICAgICAgdGhpcy5zZXQoe1xyXG4gICAgICAgICAgICBzY3JvbGxMZWZ0OiBvZmZzZXRMZWZ0IC0gKG5hdldpZHRoIC0gdGFiV2lkdGgpIC8gMlxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBvblRvdWNoU3RhcnQoZXZlbnQ6IFdlYXBwLlRvdWNoRXZlbnQpIHtcclxuICAgICAgaWYgKCF0aGlzLmRhdGEuc3dpcGVhYmxlKSByZXR1cm47XHJcblxyXG4gICAgICB0aGlzLnRvdWNoU3RhcnQoZXZlbnQpO1xyXG4gICAgfSxcclxuXHJcbiAgICBvblRvdWNoTW92ZShldmVudDogV2VhcHAuVG91Y2hFdmVudCkge1xyXG4gICAgICBpZiAoIXRoaXMuZGF0YS5zd2lwZWFibGUpIHJldHVybjtcclxuXHJcbiAgICAgIHRoaXMudG91Y2hNb3ZlKGV2ZW50KTtcclxuICAgIH0sXHJcblxyXG4gICAgLy8gd2F0Y2ggc3dpcGUgdG91Y2ggZW5kXHJcbiAgICBvblRvdWNoRW5kKCkge1xyXG4gICAgICBpZiAoIXRoaXMuZGF0YS5zd2lwZWFibGUpIHJldHVybjtcclxuXHJcbiAgICAgIGNvbnN0IHsgYWN0aXZlLCB0YWJzIH0gPSB0aGlzLmRhdGE7XHJcblxyXG4gICAgICBjb25zdCB7IGRpcmVjdGlvbiwgZGVsdGFYLCBvZmZzZXRYIH0gPSB0aGlzO1xyXG4gICAgICBjb25zdCBtaW5Td2lwZURpc3RhbmNlID0gNTA7XHJcblxyXG4gICAgICBpZiAoZGlyZWN0aW9uID09PSAnaG9yaXpvbnRhbCcgJiYgb2Zmc2V0WCA+PSBtaW5Td2lwZURpc3RhbmNlKSB7XHJcbiAgICAgICAgaWYgKGRlbHRhWCA+IDAgJiYgYWN0aXZlICE9PSAwKSB7XHJcbiAgICAgICAgICB0aGlzLnNldEFjdGl2ZShhY3RpdmUgLSAxKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGRlbHRhWCA8IDAgJiYgYWN0aXZlICE9PSB0YWJzLmxlbmd0aCAtIDEpIHtcclxuICAgICAgICAgIHRoaXMuc2V0QWN0aXZlKGFjdGl2ZSArIDEpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSxcclxuXHJcbiAgICBzZXRXcmFwU3R5bGUoKSB7XHJcbiAgICAgIGNvbnN0IHsgb2Zmc2V0VG9wLCBwb3NpdGlvbiB9ID0gdGhpcy5kYXRhO1xyXG4gICAgICBsZXQgd3JhcFN0eWxlO1xyXG5cclxuICAgICAgc3dpdGNoIChwb3NpdGlvbikge1xyXG4gICAgICAgIGNhc2UgJ3RvcCc6XHJcbiAgICAgICAgICB3cmFwU3R5bGUgPSBgXHJcbiAgICAgICAgICAgIHRvcDogJHtvZmZzZXRUb3B9cHg7XHJcbiAgICAgICAgICAgIHBvc2l0aW9uOiBmaXhlZDtcclxuICAgICAgICAgIGA7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdib3R0b20nOlxyXG4gICAgICAgICAgd3JhcFN0eWxlID0gYFxyXG4gICAgICAgICAgICB0b3A6IGF1dG87XHJcbiAgICAgICAgICAgIGJvdHRvbTogMDtcclxuICAgICAgICAgIGA7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgd3JhcFN0eWxlID0gJyc7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIGN1dCBkb3duIGBzZXRgXHJcbiAgICAgIGlmICh3cmFwU3R5bGUgPT09IHRoaXMuZGF0YS53cmFwU3R5bGUpIHJldHVybjtcclxuXHJcbiAgICAgIHRoaXMuc2V0KHtcclxuICAgICAgICB3cmFwU3R5bGVcclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIC8vIGFkanVzdCB0YWIgcG9zaXRpb25cclxuICAgIG9uU2Nyb2xsKHNjcm9sbFRvcCkge1xyXG4gICAgICBpZiAoIXRoaXMuZGF0YS5zdGlja3kpIHJldHVybjtcclxuXHJcbiAgICAgIGNvbnN0IHsgb2Zmc2V0VG9wIH0gPSB0aGlzLmRhdGE7XHJcblxyXG4gICAgICB0aGlzLmdldFJlY3QoJy5zcHVpLXRhYnMnKS50aGVuKHJlY3QgPT4ge1xyXG4gICAgICAgIGNvbnN0IHsgdG9wLCBoZWlnaHQgfSA9IHJlY3Q7XHJcblxyXG4gICAgICAgIHRoaXMuZ2V0UmVjdCgnLnNwdWktdGFic19fd3JhcCcpLnRoZW4ocmVjdCA9PiB7XHJcbiAgICAgICAgICBjb25zdCB7IGhlaWdodDogd3JhcEhlaWdodCB9ID0gcmVjdDtcclxuICAgICAgICAgIGxldCBwb3NpdGlvbiA9ICcnO1xyXG5cclxuICAgICAgICAgIGlmIChvZmZzZXRUb3AgPiB0b3AgKyBoZWlnaHQgLSB3cmFwSGVpZ2h0KSB7XHJcbiAgICAgICAgICAgIHBvc2l0aW9uID0gJ2JvdHRvbSc7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKG9mZnNldFRvcCA+IHRvcCkge1xyXG4gICAgICAgICAgICBwb3NpdGlvbiA9ICd0b3AnO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIHRoaXMuJGVtaXQoJ3Njcm9sbCcsIHtcclxuICAgICAgICAgICAgc2Nyb2xsVG9wOiBzY3JvbGxUb3AgKyBvZmZzZXRUb3AsXHJcbiAgICAgICAgICAgIGlzRml4ZWQ6IHBvc2l0aW9uID09PSAndG9wJ1xyXG4gICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgaWYgKHBvc2l0aW9uICE9PSB0aGlzLmRhdGEucG9zaXRpb24pIHtcclxuICAgICAgICAgICAgdGhpcy5zZXQoe1xyXG4gICAgICAgICAgICAgIHBvc2l0aW9uXHJcbiAgICAgICAgICAgIH0sICgpID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLnNldFdyYXBTdHlsZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG59KTtcclxuIl19
