import { SpuiComponent } from '../common/component';
SpuiComponent({
  props: {
    title: String,
    value: String,
    loading: Boolean,
    itemHeight: {
      type: Number,
      value: 44
    },
    visibleItemCount: {
      type: Number,
      value: 5
    },
    columnsNum: {
      type: [String, Number],
      value: 3
    },
    areaList: {
      type: Object,
      value: {}
    }
  },
  data: {
    pickerValue: [0, 0, 0],
    columns: []
  },
  watch: {
    value(value) {
      this.code = value;
      this.setValues();
    },

    areaList: 'setValues'
  },
  methods: {
    onCancel() {
      this.$emit('cancel', {
        values: this.getValues(),
        indexs: this.getIndexs(),
        detail: this.getDetail()
      });
    },

    onConfirm() {
      this.$emit('confirm', {
        values: this.getValues(),
        indexs: this.getIndexs(),
        detail: this.getDetail()
      });
    },

    onChange(event) {
      const {
        value
      } = event.detail;
      const {
        pickerValue
      } = this.data;
      const displayColumns = this.getDisplayColumns();
      const index = pickerValue.findIndex((item, index) => item !== value[index]);
      const values = displayColumns[index];

      if (index < 0 || value[index] < 0 || !values[value[index]]) {
        return;
      }

      this.code = values[value[index]].code;
      this.setValues();
      this.$emit('change', {
        picker: this,
        values: this.getValues(),
        index
      });
    },

    getList(type, code) {
      let result = [];

      if (type !== 'province' && !code) {
        return result;
      }

      const list = this.data.areaList && this.data.areaList[`${type}_list`] || {};
      result = Object.keys(list).map(code => ({
        code,
        name: list[code]
      }));

      if (code) {
        // oversea code
        if (code[0] === '9' && type === 'city') {
          code = '9';
        }

        result = result.filter(item => item.code.indexOf(code) === 0);
      }

      return result;
    },

    getIndex(type, code) {
      let compareNum = type === 'province' ? 2 : type === 'city' ? 4 : 6;
      const list = this.getList(type, code.slice(0, compareNum - 2)); // oversea code

      if (code[0] === '9' && type === 'province') {
        compareNum = 1;
      }

      code = code.slice(0, compareNum);

      for (let i = 0; i < list.length; i++) {
        if (list[i].code.slice(0, compareNum) === code) {
          return i;
        }
      }

      return 0;
    },

    setValues() {
      let code = this.code || this.data.areaList && Object.keys(this.data.areaList.county_list || {})[0] || '';
      const province = this.getList('province');
      const city = this.getList('city', code.slice(0, 2));
      this.set({
        'columns[0]': province,
        'columns[1]': city
      });

      if (city.length && code.slice(2, 4) === '00') {
        code = city[0].code;
      }

      this.set({
        'columns[2]': this.getList('county', code.slice(0, 4)),
        pickerValue: [this.getIndex('province', code), this.getIndex('city', code), this.getIndex('county', code)]
      });
    },

    getValues() {
      const {
        pickerValue = []
      } = this.data;
      const displayColumns = this.getDisplayColumns();
      return displayColumns.map((option, index) => option[pickerValue[index]]).filter(value => !!value);
    },

    getIndexs() {
      const {
        pickerValue,
        columnsNum
      } = this.data;
      return pickerValue.slice(0, columnsNum);
    },

    getDetail() {
      const values = this.getValues();
      const area = {
        code: '',
        country: '',
        province: '',
        city: '',
        county: ''
      };

      if (!values.length) {
        return area;
      }

      const names = values.map(item => item.name);
      area.code = values[values.length - 1].code;

      if (area.code[0] === '9') {
        area.country = names[1] || '';
        area.province = names[2] || '';
      } else {
        area.province = names[0] || '';
        area.city = names[1] || '';
        area.county = names[2] || '';
      }

      return area;
    },

    reset() {
      this.code = '';
      this.setValues();
    },

    getDisplayColumns() {
      const {
        columns = [],
        columnsNum
      } = this.data;
      return columns.slice(0, +columnsNum);
    }

  }
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFyZWEvaW5kZXgudHMiXSwibmFtZXMiOlsiU3B1aUNvbXBvbmVudCIsInByb3BzIiwidGl0bGUiLCJTdHJpbmciLCJ2YWx1ZSIsImxvYWRpbmciLCJCb29sZWFuIiwiaXRlbUhlaWdodCIsInR5cGUiLCJOdW1iZXIiLCJ2aXNpYmxlSXRlbUNvdW50IiwiY29sdW1uc051bSIsImFyZWFMaXN0IiwiT2JqZWN0IiwiZGF0YSIsInBpY2tlclZhbHVlIiwiY29sdW1ucyIsIndhdGNoIiwiY29kZSIsInNldFZhbHVlcyIsIm1ldGhvZHMiLCJvbkNhbmNlbCIsIiRlbWl0IiwidmFsdWVzIiwiZ2V0VmFsdWVzIiwiaW5kZXhzIiwiZ2V0SW5kZXhzIiwiZGV0YWlsIiwiZ2V0RGV0YWlsIiwib25Db25maXJtIiwib25DaGFuZ2UiLCJldmVudCIsImRpc3BsYXlDb2x1bW5zIiwiZ2V0RGlzcGxheUNvbHVtbnMiLCJpbmRleCIsImZpbmRJbmRleCIsIml0ZW0iLCJwaWNrZXIiLCJnZXRMaXN0IiwicmVzdWx0IiwibGlzdCIsImtleXMiLCJtYXAiLCJuYW1lIiwiZmlsdGVyIiwiaW5kZXhPZiIsImdldEluZGV4IiwiY29tcGFyZU51bSIsInNsaWNlIiwiaSIsImxlbmd0aCIsImNvdW50eV9saXN0IiwicHJvdmluY2UiLCJjaXR5Iiwic2V0Iiwib3B0aW9uIiwiYXJlYSIsImNvdW50cnkiLCJjb3VudHkiLCJuYW1lcyIsInJlc2V0Il0sIm1hcHBpbmdzIjoiQUFBQSxTQUFTQSxhQUFULFFBQThCLHFCQUE5QjtBQU9BQSxhQUFhLENBQUM7QUFDWkMsRUFBQUEsS0FBSyxFQUFFO0FBQ0xDLElBQUFBLEtBQUssRUFBRUMsTUFERjtBQUVMQyxJQUFBQSxLQUFLLEVBQUVELE1BRkY7QUFHTEUsSUFBQUEsT0FBTyxFQUFFQyxPQUhKO0FBSUxDLElBQUFBLFVBQVUsRUFBRTtBQUNWQyxNQUFBQSxJQUFJLEVBQUVDLE1BREk7QUFFVkwsTUFBQUEsS0FBSyxFQUFFO0FBRkcsS0FKUDtB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QU9FLE9BQU8sQ0FBQ2dDLEtBQVIsQ0FBYyxDQUFkLEVBQWlCLENBQUNyQyxVQUFsQixDQUFQO0FBQ0Q7O0FBL0pNO0FBckNHLENBQUQsQ0FBYiIsImZpbGUiOiJhcmVhL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3B1aUNvbXBvbmVudCB9IGZyb20gJy4uL2NvbW1vbi9jb21wb25lbnQnO1xyXG5cclxudHlwZSBBcmVhSXRlbSA9IHtcclxuICBuYW1lOiBzdHJpbmc7XHJcbiAgY29kZTogc3RyaW5nO1xyXG59O1xyXG5cclxuU3B1aUNvbXBvbmVudCh7XHJcbiAgcHJvcHM6IHtcclxuICAgIHRpdGxlOiBTdHJpbmcsXHJcbiAgICB2YWx1ZTogU3RyaW5nLFxyXG4gICAgbG9hZGluZzogQm9vbGVhbixcclxuICAgIGl0ZW1IZWlnaHQ6IHtcclxuICAgICAgdHlwZTogTnVtYmVyLFxyXG4gICAgICB2YWx1ZTogNDRcclxuICAgIH0sXHJcbiAgICB2aXNpYmxlSXRlbUNvdW50OiB7XHJcbiAgICAgIHR5cGU6IE51bWJlcixcclxuICAgICAgdmFsdWU6IDVcclxuICAgIH0sXHJcbiAgICBjb2x1bW5zTnVtOiB7XHJcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXHJcbiAgICAgIHZhbHVlOiAzXHJcbiAgICB9LFxyXG4gICAgYXJlYUxpc3Q6IHtcclxuICAgICAgdHlwZTogT2JqZWN0LFxyXG4gICAgICB2YWx1ZToge31cclxuICAgIH1cclxuICB9LFxyXG5cclxuICBkYXRhOiB7XHJcbiAgICBwaWNrZXJWYWx1ZTogWzAsIDAsIDBdLFxyXG4gICAgY29sdW1uczogW11cclxuICB9LFxyXG5cclxuICB3YXRjaDoge1xyXG4gICAgdmFsdWUodmFsdWUpIHtcclxuICAgICAgdGhpcy5jb2RlID0gdmFsdWU7XHJcbiAgICAgIHRoaXMuc2V0VmFsdWVzKCk7XHJcbiAgICB9LFxyXG5cclxuICAgIGFyZWFMaXN0OiAnc2V0VmFsdWVzJ1xyXG4gIH0sXHJcblxyXG4gIG1ldGhvZHM6IHtcclxuICAgIG9uQ2FuY2VsKCkge1xyXG4gICAgICB0aGlzLiRlbWl0KCdjYW5jZWwnLCB7XHJcbiAgICAgICAgdmFsdWVzOiB0aGlzLmdldFZhbHVlcygpLFxyXG4gICAgICAgIGluZGV4czogdGhpcy5nZXRJbmRleHMoKSxcclxuICAgICAgICBkZXRhaWw6IHRoaXMuZ2V0RGV0YWlsKClcclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIG9uQ29uZmlybSgpIHtcclxuICAgICAgdGhpcy4kZW1pdCgnY29uZmlybScsIHtcclxuICAgICAgICB2YWx1ZXM6IHRoaXMuZ2V0VmFsdWVzKCksXHJcbiAgICAgICAgaW5kZXhzOiB0aGlzLmdldEluZGV4cygpLFxyXG4gICAgICAgIGRldGFpbDogdGhpcy5nZXREZXRhaWwoKVxyXG4gICAgICB9KTtcclxuICAgIH0sXHJcblxyXG4gICAgb25DaGFuZ2UoZXZlbnQ6IFdlYXBwLkV2ZW50KSB7XHJcbiAgICAgIGNvbnN0IHsgdmFsdWUgfSA9IGV2ZW50LmRldGFpbDtcclxuICAgICAgY29uc3QgeyBwaWNrZXJWYWx1ZSB9ID0gdGhpcy5kYXRhO1xyXG4gICAgICBjb25zdCBkaXNwbGF5Q29sdW1ucyA9IHRoaXMuZ2V0RGlzcGxheUNvbHVtbnMoKTtcclxuICAgICAgY29uc3QgaW5kZXggPSBwaWNrZXJWYWx1ZS5maW5kSW5kZXgoXHJcbiAgICAgICAgKGl0ZW0sIGluZGV4KSA9PiBpdGVtICE9PSB2YWx1ZVtpbmRleF1cclxuICAgICAgKTtcclxuICAgICAgY29uc3QgdmFsdWVzID0gZGlzcGxheUNvbHVtbnNbaW5kZXhdO1xyXG5cclxuICAgICAgaWYgKGluZGV4IDwgMCB8fCB2YWx1ZVtpbmRleF0gPCAwIHx8ICF2YWx1ZXNbdmFsdWVbaW5kZXhdXSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5jb2RlID0gdmFsdWVzW3ZhbHVlW2luZGV4XV0uY29kZTtcclxuICAgICAgdGhpcy5zZXRWYWx1ZXMoKTtcclxuICAgICAgdGhpcy4kZW1pdCgnY2hhbmdlJywge1xyXG4gICAgICAgIHBpY2tlcjogdGhpcyxcclxuICAgICAgICB2YWx1ZXM6IHRoaXMuZ2V0VmFsdWVzKCksXHJcbiAgICAgICAgaW5kZXhcclxuICAgICAgfSk7XHJcbiAgICB9LFxyXG5cclxuICAgIGdldExpc3QodHlwZTogc3RyaW5nLCBjb2RlPzogc3RyaW5nKTogQXJlYUl0ZW1bXSB7XHJcbiAgICAgIGxldCByZXN1bHQgPSBbXTtcclxuICAgICAgaWYgKHR5cGUgIT09ICdwcm92aW5jZScgJiYgIWNvZGUpIHtcclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBsaXN0ID0gdGhpcy5kYXRhLmFyZWFMaXN0ICYmIHRoaXMuZGF0YS5hcmVhTGlzdFtgJHt0eXBlfV9saXN0YF0gfHwge307XHJcbiAgICAgIHJlc3VsdCA9IE9iamVjdC5rZXlzKGxpc3QpLm1hcChjb2RlID0+ICh7XHJcbiAgICAgICAgY29kZSxcclxuICAgICAgICBuYW1lOiBsaXN0W2NvZGVdXHJcbiAgICAgIH0pKTtcclxuXHJcbiAgICAgIGlmIChjb2RlKSB7XHJcbiAgICAgICAgLy8gb3ZlcnNlYSBjb2RlXHJcbiAgICAgICAgaWYgKGNvZGVbMF0gPT09ICc5JyAmJiB0eXBlID09PSAnY2l0eScpIHtcclxuICAgICAgICAgIGNvZGUgPSAnOSc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXN1bHQgPSByZXN1bHQuZmlsdGVyKGl0ZW0gPT4gaXRlbS5jb2RlLmluZGV4T2YoY29kZSkgPT09IDApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfSxcclxuXHJcbiAgICBnZXRJbmRleCh0eXBlOiBzdHJpbmcsIGNvZGU6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgICAgIGxldCBjb21wYXJlTnVtID0gdHlwZSA9PT0gJ3Byb3ZpbmNlJyA/IDIgOiB0eXBlID09PSAnY2l0eScgPyA0IDogNjtcclxuICAgICAgY29uc3QgbGlzdCA9IHRoaXMuZ2V0TGlzdCh0eXBlLCBjb2RlLnNsaWNlKDAsIGNvbXBhcmVOdW0gLSAyKSk7XHJcblxyXG4gICAgICAvLyBvdmVyc2VhIGNvZGVcclxuICAgICAgaWYgKGNvZGVbMF0gPT09ICc5JyAmJiB0eXBlID09PSAncHJvdmluY2UnKSB7XHJcbiAgICAgICAgY29tcGFyZU51bSA9IDE7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvZGUgPSBjb2RlLnNsaWNlKDAsIGNvbXBhcmVOdW0pO1xyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBpZiAobGlzdFtpXS5jb2RlLnNsaWNlKDAsIGNvbXBhcmVOdW0pID09PSBjb2RlKSB7XHJcbiAgICAgICAgICByZXR1cm4gaTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiAwO1xyXG4gICAgfSxcclxuXHJcbiAgICBzZXRWYWx1ZXMoKSB7XHJcbiAgICAgIGxldCBjb2RlID1cclxuICAgICAgICB0aGlzLmNvZGUgfHxcclxuICAgICAgICAodGhpcy5kYXRhLmFyZWFMaXN0ICYmXHJcbiAgICAgICAgICBPYmplY3Qua2V5cyh0aGlzLmRhdGEuYXJlYUxpc3QuY291bnR5X2xpc3QgfHwge30pWzBdKSB8fFxyXG4gICAgICAgICcnO1xyXG4gICAgICBjb25zdCBwcm92aW5jZSA9IHRoaXMuZ2V0TGlzdCgncHJvdmluY2UnKTtcclxuICAgICAgY29uc3QgY2l0eSA9IHRoaXMuZ2V0TGlzdCgnY2l0eScsIGNvZGUuc2xpY2UoMCwgMikpO1xyXG5cclxuICAgICAgdGhpcy5zZXQoe1xyXG4gICAgICAgICdjb2x1bW5zWzBdJzogcHJvdmluY2UsXHJcbiAgICAgICAgJ2NvbHVtbnNbMV0nOiBjaXR5XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgaWYgKGNpdHkubGVuZ3RoICYmIGNvZGUuc2xpY2UoMiwgNCkgPT09ICcwMCcpIHtcclxuICAgICAgICBjb2RlID0gY2l0eVswXS5jb2RlO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLnNldCh7XHJcbiAgICAgICAgJ2NvbHVtbnNbMl0nOiB0aGlzLmdldExpc3QoJ2NvdW50eScsIGNvZGUuc2xpY2UoMCwgNCkpLFxyXG4gICAgICAgIHBpY2tlclZhbHVlOiBbXHJcbiAgICAgICAgICB0aGlzLmdldEluZGV4KCdwcm92aW5jZScsIGNvZGUpLFxyXG4gICAgICAgICAgdGhpcy5nZXRJbmRleCgnY2l0eScsIGNvZGUpLFxyXG4gICAgICAgICAgdGhpcy5nZXRJbmRleCgnY291bnR5JywgY29kZSlcclxuICAgICAgICBdXHJcbiAgICAgIH0pO1xyXG4gICAgfSxcclxuXHJcbiAgICBnZXRWYWx1ZXMoKSB7XHJcbiAgICAgIGNvbnN0IHsgcGlja2VyVmFsdWUgPSBbXSB9ID0gdGhpcy5kYXRhO1xyXG4gICAgICBjb25zdCBkaXNwbGF5Q29sdW1ucyA9IHRoaXMuZ2V0RGlzcGxheUNvbHVtbnMoKTtcclxuICAgICAgcmV0dXJuIGRpc3BsYXlDb2x1bW5zXHJcbiAgICAgICAgLm1hcCgob3B0aW9uLCBpbmRleCkgPT4gb3B0aW9uW3BpY2tlclZhbHVlW2luZGV4XV0pXHJcbiAgICAgICAgLmZpbHRlcih2YWx1ZSA9PiAhIXZhbHVlKTtcclxuICAgIH0sXHJcblxyXG4gICAgZ2V0SW5kZXhzKCkge1xyXG4gICAgICBjb25zdCB7IHBpY2tlclZhbHVlLCBjb2x1bW5zTnVtIH0gPSB0aGlzLmRhdGE7XHJcbiAgICAgIHJldHVybiBwaWNrZXJWYWx1ZS5zbGljZSgwLCBjb2x1bW5zTnVtKTtcclxuICAgIH0sXHJcblxyXG4gICAgZ2V0RGV0YWlsKCkge1xyXG4gICAgICBjb25zdCB2YWx1ZXMgPSB0aGlzLmdldFZhbHVlcygpO1xyXG4gICAgICBjb25zdCBhcmVhID0ge1xyXG4gICAgICAgIGNvZGU6ICcnLFxyXG4gICAgICAgIGNvdW50cnk6ICcnLFxyXG4gICAgICAgIHByb3ZpbmNlOiAnJyxcclxuICAgICAgICBjaXR5OiAnJyxcclxuICAgICAgICBjb3VudHk6ICcnXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBpZiAoIXZhbHVlcy5sZW5ndGgpIHtcclxuICAgICAgICByZXR1cm4gYXJlYTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgbmFtZXMgPSB2YWx1ZXMubWFwKGl0ZW0gPT4gaXRlbS5uYW1lKTtcclxuICAgICAgYXJlYS5jb2RlID0gdmFsdWVzW3ZhbHVlcy5sZW5ndGggLSAxXS5jb2RlO1xyXG4gICAgICBpZiAoYXJlYS5jb2RlWzBdID09PSAnOScpIHtcclxuICAgICAgICBhcmVhLmNvdW50cnkgPSBuYW1lc1sxXSB8fCAnJztcclxuICAgICAgICBhcmVhLnByb3ZpbmNlID0gbmFtZXNbMl0gfHwgJyc7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYXJlYS5wcm92aW5jZSA9IG5hbWVzWzBdIHx8ICcnO1xyXG4gICAgICAgIGFyZWEuY2l0eSA9IG5hbWVzWzFdIHx8ICcnO1xyXG4gICAgICAgIGFyZWEuY291bnR5ID0gbmFtZXNbMl0gfHwgJyc7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiBhcmVhO1xyXG4gICAgfSxcclxuXHJcbiAgICByZXNldCgpIHtcclxuICAgICAgdGhpcy5jb2RlID0gJyc7XHJcbiAgICAgIHRoaXMuc2V0VmFsdWVzKCk7XHJcbiAgICB9LFxyXG5cclxuICAgIGdldERpc3BsYXlDb2x1bW5zKCkge1xyXG4gICAgICBjb25zdCB7IGNvbHVtbnMgPSBbXSwgY29sdW1uc051bSB9ID0gdGhpcy5kYXRhO1xyXG4gICAgICByZXR1cm4gY29sdW1ucy5zbGljZSgwLCArY29sdW1uc051bSk7XHJcbiAgICB9XHJcbiAgfVxyXG59KTtcclxuIl19
